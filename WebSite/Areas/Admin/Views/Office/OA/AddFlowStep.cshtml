@functions{
    //B_User buser = new B_User();
    //        B_Structure strBll = new B_Structure();
    //        M_MisProcedure proMod = new M_MisProcedure();
    //        B_MisProcedure proBll = new B_MisProcedure();
    //        B_MisProLevel stepBll = new B_MisProLevel();
    //        //流程ID
    //        public int proID { get { return DataConvert.CLng(Request.QueryString["ProID"]); } }
    //        public int Mid { get { return DataConvert.CLng(Request.QueryString["StepID"]); } }
    //        protected void Page_Load(object sender, EventArgs e)
    //        {
    //            if (proID < 1) {function.WriteErrMsg("请先选定流程!!!"); }
    //            if (!IsPostBack)
    //            {
    //                ParentID_DP.DataSource = stepBll.SelByProID(proID);
    //                ParentID_DP.DataBind();
    //                ParentID_DP.Items.Insert(0, new ListItem("主线流程", "0"));
    //                if (Mid > 0)
    //                {
    //                    saveBtn.Text = "修改步骤";
    //                    M_MisProLevel stepMod = stepBll.SelReturnModel(Mid);
    //                    stepCodeT.Text = stepMod.stepNum.ToString();
    //                    stepNameT.Text = stepMod.stepName;
    //                    //------------------主办,协议信息
    //                    ReferUser_Alias_T.Text = stepMod.ReferUser_Alias;
    //                    ReferUser_Hid.Value = stepMod.ReferUser;
    //                    referUserDatas_Hid.Value = JsonConvert.SerializeObject(buser.SelectUserByIds(stepMod.ReferUser));
    //                    ReferUser_T.Text = buser.GetUserNameByIDS(stepMod.ReferUser);
    //                    //referGroup_Hid.Value = stepMod.ReferGroup;
    //                    CCUser_Alias_T.Text = stepMod.CCUser_Alias;
    //                    CCUser_Allow_Chk.Checked = stepMod.CCUser_Allow == 1;
    //                    CCUser_Hid.Value = stepMod.CCUser;
    //                    ccUserDatas_Hid.Value = JsonConvert.SerializeObject(buser.SelectUserByIds(stepMod.CCUser));
    //                    CCUser_T.Text = buser.GetUserNameByIDS(stepMod.CCUser);
    //                    CCUser_HQ.Checked=stepMod.StepAuth.CCUser_HQ;
    //                    HelpUser_Alias_T.Text = stepMod.HelpUser_Alias;
    //                    HelpUser_Allow_Chk.Checked = stepMod.HelpUser_Allow == 1;

    //                    emailAlertD.Value = stepMod.EmailAlert;
    //                    emailGroupD.Value = stepMod.EmailGroup;
    //                    smsAlertD.Value = stepMod.SmsAlert;
    //                    smsGroupD.Value = stepMod.SmsGroup;
    //                    emailAlertT.Text = buser.GetUserNameByIDS(stepMod.EmailAlert);
    //                    emailGroupT.Text = strBll.SelStrNameByIDS(stepMod.EmailGroup);
    //                    smsAlertT.Text = buser.GetUserNameByIDS(stepMod.SmsAlert);
    //                    smsGroupT.Text = strBll.SelStrNameByIDS(stepMod.SmsGroup);
    //                    hqOptionDP.SelectedValue = stepMod.HQoption.ToString();
    //                    qzzjDP.SelectedValue = stepMod.Qzzjoption.ToString();
    //                    htDP.SelectedValue = stepMod.HToption.ToString();
    //                    remindT.Text = stepMod.Remind;


    //                    RUser_ManageAttach.Checked = stepMod.StepAuth.RUser_ManageAttach;
    //                    RUser_ChangeUser.Checked = stepMod.StepAuth.RUser_ChangeUser;
    //                    CCUser_Write.Checked = stepMod.StepAuth.CCUser_Write;
    //                    HUser_Write.Checked = stepMod.StepAuth.HUser_Write;
    //                    ParentID_DP.SelectedValue = stepMod.ParentID.ToString();

    //                    function.Script(this, "SetRadVal('next_rad','" + stepMod.DocAuth + "');");
    //                    function.Script(this, "SetChkVal('nextop_chk','" + stepMod.NextOP + "');");
    //                }
    //                Call.SetBreadCrumb(Master, "<li><a href='" + CustomerPageAction.customPath2 + "Main.aspx'>工作台</a></li><li><a href='../Config/SiteOption.aspx'>系统设置</a></li><li><a href='AddFlow.aspx?proID=" + proID + "'>流程设计</a></li><li class='active'>添加步骤</a></li>");
    //            }
    //        }
    //        /// <summary>
    //        /// 产生序号
    //        /// </summary>
    //        /// <param name="pid">目标流程的ID</param>
    //        /// <returns></returns>
    //        private int GenStepNum(int proid, int parentid)
    //        {
    //            int stepNum = DataConvert.CLng(DBCenter.ExecuteScala("ZL_MisProLevel", "MAX(StepNum)", "ProID=" + proid + " AND ParentID=" + parentid));
    //            return (stepNum + 1);
    //        }
    //        protected void saveBtn_Click(object sender, EventArgs e)
    //        {
    //            M_MisProLevel stepMod = new M_MisProLevel();
    //            if (Mid > 0) { stepMod = stepBll.SelReturnModel(Mid); }
    //            stepMod.stepName = stepNameT.Text.Trim();
    //            //stepModel.CCGroup = StrHelper.PureIDSForDB(ccGroup_Hid.Value);
    //            stepMod.HQoption = DataConvert.CLng(hqOptionDP.SelectedValue);
    //            stepMod.Qzzjoption = DataConvert.CLng(qzzjDP.SelectedValue);
    //            stepMod.HToption = DataConvert.CLng(htDP.SelectedValue);
    //            stepMod.EmailAlert = emailAlertD.Value.TrimEnd(',');
    //            stepMod.EmailGroup = emailGroupD.Value.TrimEnd(',');
    //            stepMod.SmsAlert = smsAlertD.Value.TrimEnd(',');
    //            stepMod.SmsGroup = smsGroupD.Value.TrimEnd(',');
    //            stepMod.Remind = remindT.Text.Trim();
    //            stepMod.DocAuth = Request.Form["next_rad"];
    //            stepMod.NextOP = Request.Form["nextop_chk"];
    //            stepMod.ParentID = Convert.ToInt32(ParentID_DP.SelectedValue);


    //            //主办协办等配置
    //            stepMod.ReferUser = StrHelper.PureIDSForDB(ReferUser_Hid.Value);
    //            stepMod.CCUser = StrHelper.PureIDSForDB(CCUser_Hid.Value);
    //            stepMod.ReferUser_Alias = ReferUser_Alias_T.Text;
    //            stepMod.CCUser_Alias = CCUser_Alias_T.Text;
    //            stepMod.CCUser_Allow = CCUser_Allow_Chk.Checked ? 1 : 0;
    //            stepMod.HelpUser_Alias = HelpUser_Alias_T.Text;
    //            stepMod.HelpUser_Allow = HelpUser_Allow_Chk.Checked ? 1 : 0;
    //            stepMod.StepAuth.RUser_ManageAttach = RUser_ManageAttach.Checked;
    //            stepMod.StepAuth.RUser_ChangeUser = RUser_ChangeUser.Checked;
    //            stepMod.StepAuth.CCUser_Write = CCUser_Write.Checked;
    //            stepMod.StepAuth.CCUser_HQ = CCUser_HQ.Checked;
    //            stepMod.StepAuth.HUser_Write = HUser_Write.Checked;
    //            if (stepMod.ID > 0)
    //            {
    //                stepBll.UpdateByID(stepMod);
    //            }
    //            else
    //            {
    //                //步骤序号只在列表页可更改
    //                stepMod.ProID = DataConvert.CLng(proID);
    //                stepMod.stepNum = GenStepNum(stepMod.ProID, stepMod.ParentID);
    //                stepBll.insert(stepMod);
    //            }
    //            function.WriteSuccessMsg("操作成功", "AddFlow.aspx?proID=" + stepMod.ProID);
    //        }


}
@section head{<title>流程设计</title> }
@section content{ 
	@*@Call.SetBread(new Bread[] {
		new Bread("{admin}"),
        new Bread("/{manage}/Config/SiteInfo.aspx","系统设置"),
		new Bread("AddFlow.aspx?proID="+ proID,"流程设计"),
        new Bread() {url="", text="添加步骤",addon="" }}
		)*@
    <div id="Addstep" class="container-fluid pr-0" runat="server">
	<div class="row sysRow list_choice">
        <table class="table table-striped table-bordered table-hover sys_table">
            <tr>
                <th class="w12rem_lg">序号</th>
                <td>
                    <asp:TextBox runat="server" CssClass="form-control" ID="stepCodeT" Enabled="false" Width="40" /></td>
            </tr>
            <tr>
                <th>步骤名称 <span  class="text-danger">*</span></th>
                <td>
                    <ZL:TextBox runat="server" CssClass="form-control max20rem" ID="stepNameT" AllowEmpty="false"  />
                </td>
            </tr>
            <tr>
                <th>步骤简述</th>
                <td><asp:TextBox runat="server" ID="remindT" CssClass="form-control max20rem" /></td>
            </tr>
            <tr><th>所属步骤</th>
                <td><asp:DropDownList runat="server" ID="ParentID_DP" DataTextField="StepName" DataValueField="ID" class="form-control max20rem" />
					<small class="text-muted">提示:指定所属父步骤,用于创建分支流程</small>
                </td>
            </tr>
            <tr>
                <th>主办人</th>
                <td>
                    <div>
                        <asp:TextBox runat="server" ID="ReferUser_Alias_T" class="form-control max20rem" placeholder="主办名称" Text="主办人" />
                        <asp:CheckBox runat="server" ID="RUser_ChangeUser" Text="更改协辅办(流程中，主办人可更改协办与辅办人员)" />
                        <asp:CheckBox runat="server" ID="RUser_ManageAttach" Text="主办人可管理附件" />
                    </div>
                    <div class="input-group max20rem" style="display:none;">
                        <asp:TextBox runat="server" ID="ReferUser_T" CssClass="form-control" />
                        <span class="input-group-btn">
                            <input type="button" value="选择" onclick="selRuser();" class="btn btn-info" />
                        </span>
                    </div>
                    <asp:HiddenField runat="server" ID="ReferUser_Hid" />
                </td>
            </tr>
            <tr>
                <th>协办人<br />(可查看与批复)</th>
                <td>
                    <div>
                        <asp:TextBox runat="server" ID="CCUser_Alias_T" class="form-control max20rem" placeholder="协办名称" Text="协办人" />
                        <asp:CheckBox runat="server" ID="CCUser_Allow_Chk" Text="允许协办" Checked="true" />
                        <asp:CheckBox runat="server" ID="CCUser_Write" Text="协办允许批复" Checked="true" />
                        <asp:CheckBox runat="server" ID="CCUser_HQ" Text="协办会签(协办必须完成会签才能进入下一步)" />
                    </div>
                    <div style="display:none;">
                        <div class="input-group max20rem">
                            <asp:TextBox runat="server" ID="CCUser_T" CssClass="form-control" />
                            <span class="input-group-btn">
                                <input type="button" value="选择" onclick="selCUser();" class="btn btn-info" />
                            </span>
                        </div>
                        <asp:HiddenField runat="server" ID="CCUser_Hid" />
                    </div>
                </td>
            </tr>
            <tr><th>辅办人<br />(权限同于协办)</th><td>
                <div>
                    <asp:TextBox runat="server" ID="HelpUser_Alias_T" class="form-control max20rem" placeholder="辅办名称,无则为辅办人" />
                    <asp:CheckBox runat="server" ID="HelpUser_Allow_Chk" Text="允许辅办" />
                    <asp:CheckBox runat="server" ID="HUser_Write" Text="辅办允许批复"  />
                </div>
            </td>
            </tr>
            <tr>
                <th>会签选项</th>
                <td>
                    <asp:DropDownList runat="server" CssClass="form-control max20rem" ID="hqOptionDP">
                        <asp:ListItem Value="0">任意一人即可</asp:ListItem>
                        <asp:ListItem Value="1" Selected="True">必须全部审核</asp:ListItem>
                    </asp:DropDownList>
					<small class="text-muted">提示:选择必须全部审核,则需要所有经办人审核并同意,才能进入下一步骤</small>
                </td>
            </tr>
            <tr>
                <th>转交</th>
                <td>
                    <asp:DropDownList runat="server" CssClass="form-control max20rem" ID="qzzjDP">
                        <asp:ListItem Value="1">允许</asp:ListItem>
                        <asp:ListItem Value="0" Selected="True">不允许</asp:ListItem>
                    </asp:DropDownList>
					<small class="text-muted">提示:经办人未办理完毕时是否允发起人强制转交</small>
					</td>
            </tr>
            <tr>
                <th>是否允许回退</th>
                <td>
                    <asp:DropDownList runat="server" CssClass="form-control max20rem" ID="htDP">
                        <asp:ListItem Value="0">不允许</asp:ListItem>
                        <asp:ListItem Value="1">允许回退上一步骤</asp:ListItem>
                        <asp:ListItem Value="2">允许回退之前步骤</asp:ListItem>
                    </asp:DropDownList>
                </td>
            </tr>
            <tr runat="server" visible="false">
                <th>转交时,邮件自动通知以下人员</th>
                <td>
                    <div class="mb-3">
                        <span class="float-left text-right">会员：</span>
                        <div class="input-group max20rem">
                            <asp:TextBox runat="server" CssClass="form-control" ID="emailAlertT" Enabled="false" />
                            <span class="input-group-btn">
                                <input type="button" id="emailSelBtn" value="选择" class="btn btn-primary" onclick="showdiv('div_share', 'emailAlert');" />
                            </span>
                        </div>
                        <asp:HiddenField runat="server" ID="emailAlertD" />
                    </div>
                    <div>
                        <span class="float-left text-right">会员组：</span>
                        <div class="input-group max20rem">
                            <asp:TextBox runat="server" CssClass="form-control" ID="emailGroupT" Enabled="false" />
                            <span class="input-group-btn">
                                <input type="button" id="Button3" value="选择" class="btn btn-primary" onclick="showdiv('div_group', 'emailGroup');" />
                            </span>
                        </div>
                        <asp:HiddenField runat="server" ID="emailGroupD" />
                    </div>
                </td>
            </tr>
            <tr runat="server" visible="false">
                <th>转交时,短信通知以下人员</th>
                <td>
                    <div class="mb-3">
                        <span class="float-left text-right">会员：</span>
                        <div class="input-group max20rem">
                            <asp:TextBox runat="server" CssClass="form-control" ID="smsAlertT" Enabled="false" />
                            <span class="input-group-btn">
                                <input type="button" id="smsSelBtn" value="选择" class="btn btn-primary" onclick="showdiv('div_share', 'smsAlert');" />
                            </span>
                        </div>
                        <asp:HiddenField runat="server" ID="smsAlertD" />
                    </div>
                    <div>
                        <span class="float-left text-right">会员组：</span>
                        <div class="input-group max20rem">
                            <asp:TextBox runat="server" CssClass="form-control" ID="smsGroupT" Enabled="false" />
                            <span class="input-group-btn">
                                <input type="button" id="Button4" value="选择" class="btn btn-primary" onclick="showdiv('div_group', 'smsGroup');" />
                            </span>
                        </div>
                        <asp:HiddenField runat="server" ID="smsGroupD" />
                    </div>
                </td>
            </tr>
            <tr>
                <th>步骤完成后,下一步权限</th>
                <td>
                    <label><input type="radio" name="next_rad" value="refer"/>主办人</label>
                    <label><input type="radio" name="next_rad" value="sender" />发起人</label>
                    <label><input type="radio" name="next_rad" value="all" checked="checked"/>主办人和发起人</label>
                </td>
            </tr>
            <tr>
                <th>步骤完成后,下一步可操作</th>
                <td>
                    <label><input type="checkbox" name="nextop_chk" value="文件归档" />文件归档</label>
                    <label><input type="checkbox" name="nextop_chk" value="文件传阅" />文件传阅</label>
            <%--        <label><input type="checkbox" name="nextop_chk" value="文件呈阅" />文件呈阅</label>--%>
                </td>
            </tr>
            <%--            <tr>
                <th>公共附件选项</th>
                <td>
                    <asp:DropDownList runat="server" ID="PublicAttachOptionDP" CssClass="form-control text_md">
                        <asp:ListItem Value="0">不允许附件</asp:ListItem>
                        <asp:ListItem Value="1" Selected="True">允许附件</asp:ListItem>
                    </asp:DropDownList>
                </td>
            </tr>--%>
            <tr>
                <th>操作</th>
                <td>
                    <asp:Button runat="server" ID="saveBtn" Text="添加步骤" OnClick="saveBtn_Click" CssClass="btn btn-info" />
                    <a href="AddFlow.aspx?proID=<%:proID %>" class="btn btn-outline-info">返回列表</a>
                </td>
            </tr>
        </table>
	</div>
    </div>
    <asp:HiddenField runat="server" ID="referUserDatas_Hid" />
    <asp:HiddenField runat="server" ID="ccUserDatas_Hid" />

}
@section script{ 
    <script src="/JS/SelectCheckBox.js"></script>
    <script src="/JS/Controls/ZL_Array.js"></script>
    <script src="/JS/Plugs/angular.min.js"></script>
    <script>
        //user.hook["ReferUser"] = userdeal;
        //user.hook["CCUser"] = userdeal;
        //function userdeal(list, select) {
        //    var names ="" ,ids="";
        //    for(var i =0;i<list.length;i++){
        //        names += list[i].UserName + ",";
        //        ids += list[i].UserID + ",";
        //    }
        //    $("#" + select + "_T").val(names);
        //    $("#" + select + "_Hid").val(ids);
        //    if (comdiag != null) { CloseComDiag(); }
        //}
        function selRuser() {
            ShowComDiag("/Common/Dialog/SelStructure.aspx?Type=AllInfo#ReferUser", "选择主办人");
        }
        function selCUser()
        {
            ShowComDiag("/Common/Dialog/SelStructure.aspx?Type=AllInfo#CCUser", "选择协办人");
        }
        function UserFunc(json, select) {
            return user.deal_def(json, select);
        }

    </script>
}
